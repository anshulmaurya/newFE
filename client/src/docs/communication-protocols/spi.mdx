# SPI Protocol

Serial Peripheral Interface (SPI) is a synchronous serial communication protocol that provides high-speed, full-duplex communication between a master device and one or more slave devices.

## SPI Basics

SPI uses four wires for communication:
- **MOSI (Master Out Slave In)**: Data from master to slave
- **MISO (Master In Slave Out)**: Data from slave to master
- **SCK (Serial Clock)**: Clock signal from the master
- **SS/CS (Slave Select/Chip Select)**: Selection signal for each slave

<Alert title="Multiple Slaves">
  When connecting multiple slave devices, each slave requires its own SS/CS line, while MOSI, MISO, and SCK are shared across all devices.
</Alert>

## How SPI Works

SPI is a **synchronous** protocol, meaning it uses a clock signal (SCK) to synchronize data transmission. This allows for higher speeds than asynchronous protocols like UART.

### SPI Modes

SPI has four operating modes (0-3) based on two parameters:
- **Clock Polarity (CPOL)**: Idle state of the clock (0 = low, 1 = high)
- **Clock Phase (CPHA)**: When data is sampled (0 = first edge, 1 = second edge)

<Table>
  <TableHeader>
    <TableRow>
      <TableHead>Mode</TableHead>
      <TableHead>CPOL</TableHead>
      <TableHead>CPHA</TableHead>
      <TableHead>Idle Clock</TableHead>
      <TableHead>Data Sampled On</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableCell>0</TableCell>
      <TableCell>0</TableCell>
      <TableCell>0</TableCell>
      <TableCell>Low</TableCell>
      <TableCell>Rising Edge</TableCell>
    </TableRow>
    <TableRow>
      <TableCell>1</TableCell>
      <TableCell>0</TableCell>
      <TableCell>1</TableCell>
      <TableCell>Low</TableCell>
      <TableCell>Falling Edge</TableCell>
    </TableRow>
    <TableRow>
      <TableCell>2</TableCell>
      <TableCell>1</TableCell>
      <TableCell>0</TableCell>
      <TableCell>High</TableCell>
      <TableCell>Falling Edge</TableCell>
    </TableRow>
    <TableRow>
      <TableCell>3</TableCell>
      <TableCell>1</TableCell>
      <TableCell>1</TableCell>
      <TableCell>High</TableCell>
      <TableCell>Rising Edge</TableCell>
    </TableRow>
  </TableBody>
</Table>

<Alert title="Mode Compatibility" variant="warning">
  When connecting to an SPI device, you must use the mode specified by the device manufacturer. Using the wrong mode will result in corrupt data.
</Alert>

### SPI Transaction Sequence

A typical SPI transaction follows these steps:

1. The master pulls the SS line LOW for the target slave
2. The master generates clock pulses on SCK
3. Data is exchanged simultaneously on MOSI and MISO
4. After data exchange, the master pulls the SS line HIGH

<Card title="SPI Timing Diagram (Mode 0)">
  ```
  SS    ̅̅ ̅̅ ̅̅ ̅̅ ̅̅ ̅̅|_______________________________|̅̅ ̅̅ ̅̅ ̅̅ ̅̅ ̅̅ ̅
  
  SCK   ̅̅ ̅̅ ̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅|_|̅̅ ̅̅ ̅̅ ̅
  
  MOSI  X===X---X===X---X===X---X===X---X===X---X===X---X===X---X===X
         B7    B6    B5    B4    B3    B2    B1    B0
  
  MISO  X===X---X===X---X===X---X===X---X===X---X===X---X===X---X===X
         B7    B6    B5    B4    B3    B2    B1    B0
  ```
</Card>

## SPI Implementation in C

Here's a basic example of SPI initialization and data exchange on an AVR microcontroller:

```c
#include <avr/io.h>

// SPI pins on PORTB
#define SPI_SS    PB2
#define SPI_MOSI  PB3
#define SPI_MISO  PB4
#define SPI_SCK   PB5

void spi_init_master(void) {
  // Set MOSI, SCK, SS as output
  DDRB |= (1 << SPI_MOSI) | (1 << SPI_SCK) | (1 << SPI_SS);
  // Set MISO as input
  DDRB &= ~(1 << SPI_MISO);
  
  // Enable SPI, set as master, and set clock rate (fck/16)
  SPCR = (1 << SPE) | (1 << MSTR) | (1 << SPR0);
}

uint8_t spi_transfer(uint8_t data) {
  // Start transmission
  SPDR = data;
  // Wait for transmission to complete
  while (!(SPSR & (1 << SPIF)));
  // Return received data
  return SPDR;
}

void spi_select_slave(void) {
  // Pull SS low to select slave
  PORTB &= ~(1 << SPI_SS);
}

void spi_deselect_slave(void) {
  // Pull SS high to deselect slave
  PORTB |= (1 << SPI_SS);
}

// Example usage to read a register from a device
uint8_t spi_read_register(uint8_t reg_addr) {
  uint8_t result;
  
  spi_select_slave();
  spi_transfer(reg_addr);  // Send register address
  result = spi_transfer(0); // Send dummy byte to receive data
  spi_deselect_slave();
  
  return result;
}
```

## SPI Speed Considerations

SPI can operate at very high speeds, typically from 1 MHz to 50+ MHz. The maximum speed depends on:

- Microcontroller capabilities
- PCB layout and trace length
- Slave device specifications
- Cable length (for off-board connections)

<Alert title="Clock Speed" variant="warning">
  Always refer to the slave device datasheet for maximum SPI clock frequency. Exceeding the maximum speed can lead to communication failures.
</Alert>

## Common SPI Interview Questions

1. **What are the advantages of SPI over I2C?**
   - Higher maximum speed
   - Full-duplex communication
   - No addressing overhead
   - Simpler protocol with fewer error conditions

2. **What is the main disadvantage of SPI when connecting many devices?**
   - Each device requires a separate SS line
   - Pin count increases linearly with device count

3. **Explain the difference between the four SPI modes**
   - They differ in clock polarity (idle state) and phase (sampling edge)
   - The mode must match the device specifications

4. **How would you implement SPI communication with multiple slaves?**
   - Use a separate SS line for each slave
   - Only one slave should be active (SS low) at a time
   - MOSI, MISO, and SCK are shared among all slaves

5. **What happens if two SPI slaves are selected simultaneously?**
   - Both slaves will try to drive the MISO line
   - This can cause bus contention and possibly damage hardware
   - Only one slave should be selected at a time

## Advantages and Disadvantages

### Advantages
- Full-duplex communication (simultaneous send and receive)
- Higher speed than I2C and UART
- No addressing needed (dedicated SS lines)
- No pull-up resistors required
- Simple protocol with minimal overhead

### Disadvantages
- Requires more pins than I2C or UART
- No built-in acknowledgment
- No flow control
- Not well-suited for long distances
- Difficult to implement with many slaves due to pin count

## Common SPI Devices

SPI is widely used in various devices such as:
- Flash memory (like SD cards)
- Display controllers
- ADCs and DACs
- Sensors (accelerometers, gyroscopes)
- Real-time clocks
- Digital potentiometers
- Ethernet controllers

## Further Learning

- [Return to Communication Protocols](/docs/communication-protocols)
- Learn about [UART](/docs/communication-protocols/uart) or [I2C](/docs/communication-protocols/i2c)
- Check out the [Getting Started](/docs/getting-started) guide